<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>D3.js</title>

        <meta name="description" content="Data-Driven Documents">
        <meta name="author" content="Georgi Krastev">

        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/solarized.css" id="theme">

        <!-- Code syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <style type="text/css">
            .reveal .footer {
                position: relative;
                bottom: 0%;
                font-size: 0.8em;
                padding-top: 2em;
            }
        </style>

<style id="migration-style">
#migration #circle circle {
  fill: none;
  pointer-events: all;
}

#migration .group path {
  fill-opacity: .5;
}

#migration path.chord {
  stroke: #000;
  stroke-width: .25px;
}

#migration #circle:hover path.fade {
  display: none;
}

#migration {
  font-family: 'Open Sans', sans-serif;
  font-size: 0.25em;
  font-weight: bold;
}
</style>

<style type="text/css" id="motivation-style">
#motivation svg {
  font: 0.2em sans-serif;
}

#motivation .y.axis path {
  display: none;
}

#motivation .y.axis line {
  stroke: #fff;
  stroke-opacity: .2;
  shape-rendering: crispEdges;
}

#motivation .y.axis .zero line {
  stroke: #000;
  stroke-opacity: 1;
}

#motivation .birthyear,
#motivation .age {
  text-anchor: middle;
}

#motivation .birthyear {
  fill: #fff;
}

#motivation rect {
  fill-opacity: .6;
  fill: #e377c2;
}

#motivation rect:first-child {
  fill: #1f77b4;
}
</style>

<style type="text/css" id="map-style">
#map path {
  fill: none;
  stroke-linejoin: round;
}

#map .land {
  fill: #ddd;
}

#map .states,
#map .hexagons path {
  stroke: #fff;
}
</style>

<style type="text/css" id="sunburst-style">
#sunburst #main {
  float: left;
  width: 750px;
}

#sunburst #sidebar {
  float: right;
  width: 100px;
}

#sunburst #sequence {
  width: 600px;
  height: 70px;
}

#sunburst #legend {
  padding: 10px 0 0 3px;
}

#sunburst #sequence text, #sunburst #legend text {
  font-weight: 600;
  fill: #fff;
}

#sunburst #chart {
  position: relative;
}

#sunburst #chart path {
  stroke: #fff;
}

#sunburst #explanation {
  position: absolute;
  top: 260px;
  left: 305px;
  width: 140px;
  text-align: center;
  color: #666;
  z-index: -1;
}

#sunburst #percentage {
  font-size: 2.5em;
}

#sunburst {
  font-family: 'Open Sans', sans-serif;
  font-size: 12px;
  font-weight: 400;
  width: 960px;
  height: 700px;
  margin-top: 10px;
}
</style>

<style id="transitions-style">
#transitions text {
  font: bold 48px monospace;
}

#transitions .enter {
  fill: green;
}

#transitions .update {
  fill: #333;
}

#transitions .exit {
  fill: brown;
}
</style>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <section id="cover">
                    <h2>
                        <svg width="96" height="91">
                            <clipPath id="clip">
                              <path d="M0,0h7.75a45.5,45.5 0 1 1 0,91h-7.75v-20h7.75a25.5,25.5 0 1 0 0,-51h-7.75zm36.2510,0h32a27.75,27.75 0 0 1 21.331,45.5a27.75,27.75 0 0 1 -21.331,45.5h-32a53.6895,53.6895 0 0 0 18.7464,-20h13.2526a7.75,7.75 0 1 0 0,-15.5h-7.75a53.6895,53.6895 0 0 0 0,-20h7.75a7.75,7.75 0 1 0 0,-15.5h-13.2526a53.6895,53.6895 0 0 0 -18.7464,-20z"></path>
                            </clipPath>
                            <linearGradient id="gradient-1" gradientUnits="userSpaceOnUse" x1="7" y1="64" x2="50" y2="107">
                              <stop offset="0" stop-color="#f9a03c"></stop>
                              <stop offset="1" stop-color="#f7974e"></stop>
                            </linearGradient>
                            <linearGradient id="gradient-2" gradientUnits="userSpaceOnUse" x1="2" y1="-2" x2="87" y2="84">
                              <stop offset="0" stop-color="#f26d58"></stop>
                              <stop offset="1" stop-color="#f9a03c"></stop>
                            </linearGradient>
                            <linearGradient id="gradient-3" gradientUnits="userSpaceOnUse" x1="45" y1="-10" x2="108" y2="53">
                              <stop offset="0" stop-color="#b84e51"></stop>
                              <stop offset="1" stop-color="#f68e48"></stop>
                            </linearGradient>
                            <g clip-path="url(#clip)">
                              <path d="M-100,-102m-27,0v300h300z" fill="url(#gradient-1)"></path>
                              <path d="M-100,-102m27,0h300v300z" fill="url(#gradient-3)"></path>
                              <path d="M-100,-102l300,300" fill="none" stroke="url(#gradient-2)" stroke-width="40"></path>
                            </g>
                          </svg>.js
                      </h2>
                    <h3>Data-Driven Documents</h3>
                    <p><small>Presented by Georgi Krastev</small></p>
                </section>

                <section data-markdown id="definition">
                    <script type="text/template">
                        ## What is it?
                        [D3.js](http://d3js.org/) is an open-source library for data visualization written in JavaScript
                        and based on SVG (Scalable Vector Graphics).

                        <span class="fragment">Disclaimer: Scalable as _"looks good on different screen sizes"_,
                        not as _"supports millions of elements"_</span>
                    </script>
                </section>

                <section>
                <section id="motivation">
                    <h2>Motivation</h2>
                    <p>It's all about the data. But what does it mean?</p>
                    <img src="/img/spreadsheet.png" style="height: 200px; margin-right: 20px;"/>
                    <strong>vs</strong>
                    <span id="motivation-plot"></span>
                    <div class="footer">
                        <small>
                            Credits: <a href="https://gist.github.com/mbostock">mbostock</a>'s block
                            <a href="http://bl.ocks.org/mbostock/4062085">#4062085</a>
                        </small>
                    </div>
                </section>
                <section class="script"></section>
                </section>

                <section data-markdown id="agenda">
                    <script type="text/template">
                        ## Outline for today
                        1. Brief overview
                        2. How to program
                        3. Examples
                        4. Discussion
                    </script>
                </section>

                <section id="history">
                    <h2>Some history</h2>
                    <ul>
                        <li>2009 - based on the experience of developing and utilizing
                        <a href="http://prefuse.org/">Prefuse and Flare</a>, Prof. Jeff Heer, Ph.D. Mike Bostock,
                        and M.S. Vadim Ogievetsky of the former <a href="http://vis.stanford.edu/">Stanford Visualization Group</a>
                        (now the <a href="http://idl.cs.washington.edu/">Interactive Data Lab</a> at UW)
                        created <a href="http://mbostock.github.io/protovis/">Protovis</a>,
                        a JavaScript library to generate SVG graphics from data.</li>
                        
                        <li class="fragment">2011 - the development of Protovis was stopped to focus on a new project,
                        D3.js that applied the lessons learned from Protovis.</li>
                    </ul>
                </section>

                <section data-markdown id="resources">
                    <script type="text/template">
                        ## Where to start?
                        * Documentation - check the [wiki](https://github.com/mbostock/d3/wiki)
                        * Learn by example - Mike Bostock&#39;s [blocks](http://bl.ocks.org/)
                        * 18,139 questions on [StackOverflow](http://stackoverflow.com/questions/tagged/d3.js) as of time of writing
                        * A lot of [plugins](https://github.com/mbostock/d3/wiki/Plugins) available
                        * [Reference paper](http://vis.stanford.edu/papers/d3) by Bostock, Ogievetsky and Heer
                        * License: [BSD](http://opensource.org/licenses/BSD-3-Clause)
                    </script>
                </section>

                <section data-markdown id="basics">
                    <script type="text/template">
                        ## First - the basics
                        * SVG
                        * Selections
                        * Transitions
                        * Scales
                        * ... and then some
                    </script>
                </section>

                <section id="svg">
<h2>SVG (is XML)</h2>
<pre><code class="hljs svg"><svg width="500" viewBox="0 0 1200 400"
     xmlns="http://www.w3.org/2000/svg" version="1.1">
  <title>Example arcs01 - arc commands in path data</title>
  <desc>Picture of a pie chart with two pie wedges and
        a picture of a line with arc blips</desc>
  <rect x="1" y="1" width="1198" height="398"
        fill="none" stroke="blue" stroke-width="1" />

  <path d="M300,200 h-150 a150,150 0 1,0 150,-150 z"
        fill="red" stroke="blue" stroke-width="5" />
  <path d="M275,175 v-150 a150,150 0 0,0 -150,150 z"
        fill="yellow" stroke="blue" stroke-width="5" />

  <path d="M600,350 l 50,-25 
           a25,25 -30 0,1 50,-25 l 50,-25 
           a25,50 -30 0,1 50,-25 l 50,-25 
           a25,75 -30 0,1 50,-25 l 50,-25 
           a25,100 -30 0,1 50,-25 l 50,-25"
        fill="none" stroke="red" stroke-width="5"  />
</svg></code></pre>
<svg width="500" viewBox="0 0 1200 400"
     xmlns="http://www.w3.org/2000/svg" version="1.1">
  <title>Example arcs01 - arc commands in path data</title>
  <desc>Picture of a pie chart with two pie wedges and
        a picture of a line with arc blips</desc>
  <rect x="1" y="1" width="1198" height="398"
        fill="none" stroke="blue" stroke-width="1" />

  <path d="M300,200 h-150 a150,150 0 1,0 150,-150 z"
        fill="red" stroke="blue" stroke-width="5" />
  <path d="M275,175 v-150 a150,150 0 0,0 -150,150 z"
        fill="yellow" stroke="blue" stroke-width="5" />

  <path d="M600,350 l 50,-25 
           a25,25 -30 0,1 50,-25 l 50,-25 
           a25,50 -30 0,1 50,-25 l 50,-25 
           a25,75 -30 0,1 50,-25 l 50,-25 
           a25,100 -30 0,1 50,-25 l 50,-25"
        fill="none" stroke="red" stroke-width="5"  />
</svg>
                </section>

                <section data-markdown id="selections">
                    <script type="text/template">
                        ## d3.select
                        DOM/SVG manipulation and data binding

                        ```js
                        d3.selectAll("p") // select all <p> elements
                            .style("color", "lavender") // set style "color" to "lavender"
                            .classed("squares")         // set "class" to "squares"
                            .attr("x", 50);             // set attribute "x" to 50px
                        
                        // create SVG container
                        var svg = d3.select("#hook").append("svg")
                            .attr("width", 640).attr("height", 480)
                            .style("fill", "#D0D0D0");
                        
                        // create SVG elements from data
                        svg.selectAll("circle") // create virtual circle template
                            .data(data)         // bind data
                            .enter()            // for each row in the data ...
                            .append("circle")   // ... set the attributes accordingly 
                            .attr("id", function(d) { return d.name })
                            .attr("fill",function(d) { return d.color });
                        ```
                    </script>
                </section>

                <section>
                <section id="transitions">
                    <h2>d3.transition</h2>
                    <p>Animating style and data changes</p>
                    <div id="transition-example"></div>

                    <pre><code class="hljs js">d3.selectAll("p") // select all paragraphs
  .transition("trans-color")   // transition with name "trans-color"
    .delay(0)                  // starting righ after trigger
    .duration(500)             // lasting 500ms
    .ease("linear")            // with linear easing progression ...
    .style("color", "pink");   // ... to color:pink</code></pre>
                    <div class="footer">
                        <small>
                            Credits: <a href="https://gist.github.com/mbostock">mbostock</a>'s block
                            <a href="http://bl.ocks.org/mbostock/3808234">#3808234</a>
                        </small>
                    </div>
                </section>
                <section class="script"></section>
                </section>

                <section id="scales">
                    <h2>d3.scale</h2>
                    <p>Mapping data points (domain) to style properties (range)</p>
                    <ul>
                        <li>Quantitative</li>
                        <ul style="font-size: 0.7em;">
                            <li><code>.linear().domain([20,80]).range([0,120]);</code></li>
                            <li><code>.quantize().domain([0,10]).range([0,3,7]);</code></li>
                            <li><code>.quantile().domain(dataset).range([0,100]);</code></li>
                        </ul>
                        <li>Ordinal</li>
                        <ul style="font-size: 0.7em;">
                            <li><code>.ordinal().domain(["R","G","B"]).rangeBands([0,60]);</code></li>
                            <li id="color-scale"><code>.category20();</code></li>
                        </ul>
                    </ul>
                </section>

                <section data-markdown>
                    <script type="text/template">
                        ## ... And more
                        * Support for `.json`, `.csv` and `.tsv` data
                        * Force-directed graphs
                        * Integration with various map APIs
                        * Again, check the [wiki](https://github.com/mbostock/d3/wiki)
                    </script>
                </section>

                <section>
                <section>
                    <h2>Click Stream Analysis</h2>
                    <p>
                        <a href="http://www.msnbc.com/">MSNBC.com</a> anonymous
                        <a href="https://archive.ics.uci.edu/ml/datasets/MSNBC.com+Anonymous+Web+Data">web data set</a>
                    </p>
                    <table style="font-size: 0.7em;">
                        <tbody>
                            <tr>
                                <td><strong>Data Set Characteristics</strong></td>
                                <td>Sequential</td>
                                <td><strong>Number of Instances</strong></td>
                                <td>989818</td>
                                <td><strong>Area</strong></td>
                                <td>Computer</td>
                            </tr>
                            <tr>
                                <td><strong>Attribute Characteristics</strong></td>
                                <td>Categorical</td>
                                <td><strong>Number of Attributes</strong></td>
                                <td>N/A</td>
                                <td><strong>Date Donated</strong></td>
                                <td>N/A</td>
                            </tr>
                            <tr>
                                <td><strong>Associated Tasks</strong></td>
                                <td>N/A</td>
                                <td><strong>Missing Values?</strong></td>
                                <td>N/A</td>
                                <td><strong>Number of Web Hits</strong></td>
                                <td>41119</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="footer">
                        <small>
                            Credits: <a href="http://bl.ocks.org/kerryrodden">kerryrodden</a>'s block
                            <a href="http://bl.ocks.org/mbostock/7090426">#7090426</a>
                        </small>
                    </div>
                </section>
                <section id="sunburst">
                    <div id="main">
                      <div id="sequence"></div>
                      <div id="chart">
                        <div id="explanation" style="visibility: hidden;">
                          <span id="percentage"></span><br/>
                          of visits begin with this sequence of pages
                        </div>
                      </div>
                    </div>
                    <div id="sidebar">
                      <input type="checkbox" id="togglelegend" checked="true"> Legend<br/>
                      <div id="legend" style="visibility: hidden;"></div>
                    </div>
                </section>
                <section class="script"></section>
                <section data-markdown>
                    <script type="text/template">
                        ### Pre-processing with Flink
                        ```scala
object MSNBC extends App {

  // set up the execution environment
  val env = ExecutionEnvironment.getExecutionEnvironment
  env.getConfig.disableSysoutLogging()

  val categories = "frontpage news tech local opinion on-air misc weather msn-news health living" +
    " business msn-sports sports summary bbs travel end" split ' '

  val sequences = env.readTextFile(
    "/media/georgy/work/Data/msnbc/msnbc990928.seq")

  val clickStream = sequences.map { seq =>
    s"${seq.trim} 18".split(' ')
      .take(6).map(_.toInt - 1)
      .map(categories).mkString(" ") -> 1
  }.groupBy("_1").sum("_2").filter(_._2 > 1)

  println(clickStream.count())
  clickStream.writeAsCsv("/media/georgy/work/Data/msnbc/click-stream",
    fieldDelimiter = ",", writeMode = WriteMode.OVERWRITE)

  env.execute("MSNBC")
}
                        ```
                    </script>
                </section>
                </section>

                <section>
                <section>
                    <h2>World Population Migration</h2>
                    <ul>
                    <li>Bilateral flows between 196 countries estimated from sequential stock tables</li>
                    <li>In the timespan 1990-2010 over 5 year periods</li>
                    <li>Provided by the World Bank</li>
                    <li>Reference: <a href="http://www.global-migration.info/">The Global Flow of People</a></li>
                    </ul>
                    <div class="footer">
                        <small>
                            Credits: <a href="https://gist.github.com/mbostock">mbostock</a>'s block
                            <a href="http://bost.ocks.org/mike/uberdata/">uberdata</a>
                        </small>
                    </div>
                </section>
                <section id="migration"></section>
                <section class="script"></section>
                <section data-markdown>
                    <script type="text/template">
                        ### Pre-processing with Scala
                        ```scala
object Migration extends App {

  val data = Source.fromFile("/home/georgy/work/edu/d3-reveal/data/migration.csv")
    .getLines().toVector.tail.map { line =>
    val record = line.replaceAll("\"", "").split(',')
    val orig = record(1).toInt - 1
    val dest = record(3).toInt - 1
    val migrants = record.slice(10, 12).map(_.toDouble).sum
    (orig, dest, migrants)
  }.distinct.sorted

  val total = data
    .map(_._3).sum

  val fractions = data
    .map { case (orig, dest, migrants) =>
      (orig, dest, migrants / total)
    }.groupBy(_._1).values
    .map(_.map(_._3).mkString("[", ",", "]"))
    .mkString("[", ",", "]")

  println(fractions)
}
                        ```
                    </script>
                </section>
                </section>

                <section>
                    <section>
                        <h2>Walmart Stores in the US</h2>
                        <ul>
                        <li>Geolocation data</li>
                        <li>Example of a binning technique</li>
                        <li>Size of the bins encodes number of stores</li>
                        <li>Color shade encodes the average store age</li>
                        </ul>
                        <div class="footer">
                            <small>
                                Credits: <a href="https://gist.github.com/mbostock">mbostock</a>'s block
                                <a href="http://bl.ocks.org/mbostock/4330486">#4330486</a>
                            </small>
                        </div>
                    </section>
                    <section id="map"></section>
                    <section class="script"></section>
                </section>

                <section data-markdown id="the-good">
                    <script type="text/template">
                        ## Discussion
                        ### The good
                        * Interactive - unlike many other alternatives
                        * The best documented library for visualization
                        * Standard web frontend - SVG, CSS and JavaScript
                        * A lot of examples available online
                    </script>
                </section>

                <section data-markdown id="the-bad">
                    <script type="text/template">
                        ## Discussion
                        ### The bad
                        * Scalability issues - SVG is not hardware-accelerated
                        * Cannot visualiza streams - update protocol missing
                        * Frontend programming can be tricky sometimes
                        * Integration with other data analysis tools still lacking
                    </script>
                </section>

                <section data-markdown id="take-away">
                    <script type="text/template">
                        ## Take away
                        * Take the time to pre-process your data! Seariously, do it.
                        * Think out of the box - try out something other than plots and histograms.
                        * Get your hands dirty - making the graphic work might reveal something more about the data.
                    </script>
                </section>

                <section data-markdown id="end">
                    <script type="text/template">
                        ## The end
                        #### Thank you!
                        #### Any Questions?
                    </script>
                </section>

            </div>

        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>
        <script src="//d3js.org/d3.v3.min.js"></script>
        <script src="//d3js.org/queue.v1.min.js"></script>
        <script src="//d3js.org/topojson.v1.min.js"></script>
        <script src="js/hexbin.js"></script>

        <script type="text/javascript">

            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                transition: 'slide', // none/fade/slide/convex/concave/zoom

                // Optional reveal.js plugins
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/notes/notes.js', async: true }
                ]
            });

        </script>

<script type="text/javascript">
    function showCode(section) {
        var code = d3.select('#' + section + ' + section.script')

        code.append('pre')
            .text('<script id="' + section + '"/>')
        
        code.append('pre').append('code')
            .attr('class', 'hljs js')
            .style('word-wrap', 'break-word')
            .text(d3.select('#' + section + '-script').text())
    }
</script>

<script type="text/javascript" id="motivation-script">
(function() {
var margin = {top: 20, right: 40, bottom: 30, left: 20},
    width = 400 - margin.left - margin.right,
    height = 200 - margin.top - margin.bottom,
    barWidth = Math.floor(width / 19) - 1;

var x = d3.scale.linear()
    .range([barWidth / 2, width - barWidth / 2]);

var y = d3.scale.linear()
    .range([height, 0]);

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("right")
    .tickSize(-width)
    .tickFormat(function(d) { return Math.round(d / 1e6) + "M"; });

// An SVG element with a bottom-right origin.
var svg = d3.select("#motivation-plot").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// A sliding container to hold the bars by birthyear.
var birthyears = svg.append("g")
    .attr("class", "birthyears");

d3.csv("data/population.csv", function(error, data) {

  // Convert strings to numbers.
  data.forEach(function(d) {
    d.people = +d.people;
    d.year = +d.year;
    d.age = +d.age;
  });

  // Compute the extent of the data set in age and years.
  var age1 = d3.max(data, function(d) { return d.age; }),
      year0 = d3.min(data, function(d) { return d.year; }),
      year1 = d3.max(data, function(d) { return d.year; }),
      year = year1;

  // Update the scale domains.
  x.domain([year1 - age1, year1]);
  y.domain([0, d3.max(data, function(d) { return d.people; })]);

  // Produce a map from year and birthyear to [male, female].
  data = d3.nest()
      .key(function(d) { return d.year; })
      .key(function(d) { return d.year - d.age; })
      .rollup(function(v) { return v.map(function(d) { return d.people; }); })
      .map(data);

  // Add an axis to show the population values.
  svg.append("g")
      .attr("class", "y axis")
      .attr("transform", "translate(" + width + ",0)")
      .call(yAxis)
      .selectAll("g")
      .filter(function(value) { return !value; })
      .classed("zero", true);

  // Add labeled rects for each birthyear (so that no enter or exit is required).
  var birthyear = birthyears.selectAll(".birthyear")
      .data(d3.range(year0 - age1, year1 + 1, 5))
      .enter().append("g")
      .attr("class", "birthyear")
      .attr("transform", function(birthyear) { return "translate(" + x(birthyear) + ",0)"; });

  birthyear.selectAll("rect")
      .data(function(birthyear) { return data[year][birthyear] || [0, 0]; })
      .enter().append("rect")
      .attr("x", -barWidth / 2)
      .attr("width", barWidth)
      .attr("y", y)
      .attr("height", function(value) { return height - y(value); });

  // Add labels to show birthyear.
  birthyear.append("text")
      .attr("y", height - 4)
      .text(function(birthyear) { return birthyear; });

  // Add labels to show age (separate; not animated).
  svg.selectAll(".age")
      .data(d3.range(0, age1 + 1, 5))
      .enter().append("text")
      .attr("class", "age")
      .attr("x", function(age) { return x(year - age); })
      .attr("y", height + 4)
      .attr("dy", ".71em")
      .text(function(age) { return age; });
});
})();
</script>

<script type="text/javascript" id="map-script">
(function () {
var width = 960,
    height = 500,
    parseDate = d3.time.format("%x").parse;

var color = d3.time.scale()
    .domain([new Date(1962, 0, 1), new Date(2006, 0, 1)])
    .range(["black", "steelblue"])
    .interpolate(d3.interpolateLab);

var hexbin = d3.hexbin()
    .size([width, height])
    .radius(8);

var radius = d3.scale.sqrt()
    .domain([0, 12])
    .range([0, 8]);

var projection = d3.geo.albers()
    .scale(1000)
    .translate([width / 2, height / 2])
    .precision(.1);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("#map").append("svg")
    .attr("width", width)
    .attr("height", height);

queue()
    .defer(d3.json, "data/us.json")
    .defer(d3.tsv, "data/walmart.tsv")
    .await(ready);

function ready(error, us, walmarts) {
  if (error) throw error;

  walmarts.forEach(function(d) {
    var p = projection(d);
    d[0] = p[0], d[1] = p[1];
    d.date = parseDate(d.date);
  });

  svg.append("path")
      .datum(topojson.feature(us, us.objects.land))
      .attr("class", "land")
      .attr("d", path);

  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("d", path);

  svg.append("g")
      .attr("class", "hexagons")
    .selectAll("path")
      .data(hexbin(walmarts).sort(function(a, b) { return b.length - a.length; }))
    .enter().append("path")
      .attr("d", function(d) { return hexbin.hexagon(radius(d.length)); })
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
      .style("fill", function(d) { return color(d3.median(d, function(d) { return +d.date; })); });
}
})();
</script>

<script type="text/javascript" id="sunburst-script">
(function () {
// Dimensions of sunburst.
var width = 750;
var height = 600;
var radius = Math.min(width, height) / 2;

// Breadcrumb dimensions: width, height, spacing, width of tip/tail.
var b = {
  w: 75, h: 30, s: 3, t: 10
};

// Mapping of step names to colors.
var category20 = d3.scale.category20();
var colors = "frontpage news tech local opinion on-air misc weather msn-news health living business msn-sports sports summary bbs travel end"
    .split(' ').reduce(function(prev, curr, i) { prev[curr] = category20(i); return prev; }, {});

// Total size of all segments; we set this later, after loading the data.
var totalSize = 0; 

var vis = d3.select("#chart").append("svg:svg")
    .attr("width", width)
    .attr("height", height)
    .append("svg:g")
    .attr("id", "container")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

var partition = d3.layout.partition()
    .size([2 * Math.PI, radius * radius])
    .value(function(d) { return d.size; });

var arc = d3.svg.arc()
    .startAngle(function(d) { return d.x; })
    .endAngle(function(d) { return d.x + d.dx; })
    .innerRadius(function(d) { return Math.sqrt(d.y); })
    .outerRadius(function(d) { return Math.sqrt(d.y + d.dy); });

// Use d3.text and d3.csv.parseRows so that we do not need to have a header
// row, and can receive the csv as an array of arrays.
d3.text("data/msnbc.csv", function(text) {
  var csv = d3.csv.parseRows(text);
  var json = buildHierarchy(csv);
  createVisualization(json);
});

// Main function to draw and set up the visualization, once we have the data.
function createVisualization(json) {

  // Basic setup of page elements.
  initializeBreadcrumbTrail();
  drawLegend();
  toggleLegend();
  d3.select("#togglelegend").on("click", toggleLegend);

  // Bounding circle underneath the sunburst, to make it easier to detect
  // when the mouse leaves the parent g.
  vis.append("svg:circle")
      .attr("r", radius)
      .style("opacity", 0);

  // For efficiency, filter nodes to keep only those large enough to see.
  var nodes = partition.nodes(json)
      .filter(function(d) {
      return (d.dx > 0.005); // 0.005 radians = 0.29 degrees
      });

  var path = vis.data([json]).selectAll("path")
      .data(nodes)
      .enter().append("svg:path")
      .attr("display", function(d) { return d.depth ? null : "none"; })
      .attr("d", arc)
      .attr("fill-rule", "evenodd")
      .style("fill", function(d) { return colors[d.name]; })
      .style("opacity", 1)
      .on("mouseover", mouseover);

  // Add the mouseleave handler to the bounding circle.
  d3.select("#container").on("mouseleave", mouseleave);

  // Get total size of the tree = value of root node from partition.
  totalSize = path.node().__data__.value;
 };

// Fade all but the current sequence, and show it in the breadcrumb trail.
function mouseover(d) {

  var percentage = (100 * d.value / totalSize).toPrecision(3);
  var percentageString = percentage + "%";
  if (percentage < 0.1) {
    percentageString = "< 0.1%";
  }

  d3.select("#percentage")
      .text(percentageString);

  d3.select("#explanation")
      .style("visibility", "");

  var sequenceArray = getAncestors(d);
  updateBreadcrumbs(sequenceArray, percentageString);

  // Fade all the segments.
  d3.selectAll("#sunburst path")
      .style("opacity", 0.3);

  // Then highlight only those that are an ancestor of the current segment.
  vis.selectAll("path")
      .filter(function(node) {
                return (sequenceArray.indexOf(node) >= 0);
              })
      .style("opacity", 1);
}

// Restore everything to full opacity when moving off the visualization.
function mouseleave(d) {

  // Hide the breadcrumb trail
  d3.select("#trail")
      .style("visibility", "hidden");

  // Deactivate all segments during transition.
  d3.selectAll("#sunburst path").on("mouseover", null);

  // Transition each segment to full opacity and then reactivate it.
  d3.selectAll("#sunburst path")
      .transition()
      .duration(1000)
      .style("opacity", 1)
      .each("end", function() {
              d3.select(this).on("mouseover", mouseover);
            });

  d3.select("#explanation")
      .style("visibility", "hidden");
}

// Given a node in a partition layout, return an array of all of its ancestor
// nodes, highest first, but excluding the root.
function getAncestors(node) {
  var path = [];
  var current = node;
  while (current.parent) {
    path.unshift(current);
    current = current.parent;
  }
  return path;
}

function initializeBreadcrumbTrail() {
  // Add the svg area.
  var trail = d3.select("#sequence").append("svg:svg")
      .attr("width", width)
      .attr("height", 50)
      .attr("id", "trail");
  // Add the label at the end, for the percentage.
  trail.append("svg:text")
    .attr("id", "endlabel")
    .style("fill", "#000");
}

// Generate a string that describes the points of a breadcrumb polygon.
function breadcrumbPoints(d, i) {
  var points = [];
  points.push("0,0");
  points.push(b.w + ",0");
  points.push(b.w + b.t + "," + (b.h / 2));
  points.push(b.w + "," + b.h);
  points.push("0," + b.h);
  if (i > 0) { // Leftmost breadcrumb; don't include 6th vertex.
    points.push(b.t + "," + (b.h / 2));
  }
  return points.join(" ");
}

// Update the breadcrumb trail to show the current sequence and percentage.
function updateBreadcrumbs(nodeArray, percentageString) {

  // Data join; key function combines name and depth (= position in sequence).
  var g = d3.select("#trail")
      .selectAll("#sunburst g")
      .data(nodeArray, function(d) { return d.name + d.depth; });

  // Add breadcrumb and label for entering nodes.
  var entering = g.enter().append("svg:g");

  entering.append("svg:polygon")
      .attr("points", breadcrumbPoints)
      .style("fill", function(d) { return colors[d.name]; });

  entering.append("svg:text")
      .attr("x", (b.w + b.t) / 2)
      .attr("y", b.h / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .text(function(d) { return d.name; });

  // Set position for entering and updating nodes.
  g.attr("transform", function(d, i) {
    return "translate(" + i * (b.w + b.s) + ", 0)";
  });

  // Remove exiting nodes.
  g.exit().remove();

  // Now move and update the percentage at the end.
  d3.select("#trail").select("#endlabel")
      .attr("x", (nodeArray.length + 0.5) * (b.w + b.s))
      .attr("y", b.h / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .text(percentageString);

  // Make the breadcrumb trail visible, if it's hidden.
  d3.select("#trail")
      .style("visibility", "");

}

function drawLegend() {

  // Dimensions of legend item: width, height, spacing, radius of rounded rect.
  var li = {
    w: 75, h: 30, s: 3, r: 3
  };

  var legend = d3.select("#legend").append("svg:svg")
      .attr("width", li.w)
      .attr("height", d3.keys(colors).length * (li.h + li.s));

  var g = legend.selectAll("#sunburst g")
      .data(d3.entries(colors))
      .enter().append("svg:g")
      .attr("transform", function(d, i) {
              return "translate(0," + i * (li.h + li.s) + ")";
           });

  g.append("svg:rect")
      .attr("rx", li.r)
      .attr("ry", li.r)
      .attr("width", li.w)
      .attr("height", li.h)
      .style("fill", function(d) { return d.value; });

  g.append("svg:text")
      .attr("x", li.w / 2)
      .attr("y", li.h / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .text(function(d) { return d.key; });
}

function toggleLegend() {
  var legend = d3.select("#legend");
  if (legend.style("visibility") == "hidden") {
    legend.style("visibility", "");
  } else {
    legend.style("visibility", "hidden");
  }
}

// Take a 2-column CSV and transform it into a hierarchical structure suitable
// for a partition layout. The first column is a sequence of step names, from
// root to leaf, separated by hyphens. The second column is a count of how 
// often that sequence occurred.
function buildHierarchy(csv) {
  var root = {"name": "root", "children": []};
  for (var i = 0; i < csv.length; i++) {
    var sequence = csv[i][0];
    var size = +csv[i][1];
    if (isNaN(size)) { // e.g. if this is a header row
      continue;
    }
    var parts = sequence.split(" ");
    var currentNode = root;
    for (var j = 0; j < parts.length; j++) {
      var children = currentNode["children"];
      var nodeName = parts[j];
      var childNode;
      if (j + 1 < parts.length) {
   // Not yet at the end of the sequence; move down the tree.
    var foundChild = false;
    for (var k = 0; k < children.length; k++) {
      if (children[k]["name"] == nodeName) {
        childNode = children[k];
        foundChild = true;
        break;
      }
    }
  // If we don't already have a child node for this branch, create it.
    if (!foundChild) {
      childNode = {"name": nodeName, "children": []};
      children.push(childNode);
    }
    currentNode = childNode;
      } else {
    // Reached the end of the sequence; create a leaf node.
    childNode = {"name": nodeName, "size": size};
    children.push(childNode);
      }
    }
  }
  return root;
};
})();
</script>

<script id="transitions-script">
(function () {
var alphabet = "abcdefghijklmnopqrstuvwxyz".split("");

var width = 800,
    height = 100;

var svg = d3.select("#transition-example").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(32," + (height / 2) + ")");

function update(data) {

  // DATA JOIN
  // Join new data with old elements, if any.
  var text = svg.selectAll("text")
      .data(data, function(d) { return d; });

  // UPDATE
  // Update old elements as needed.
  text.attr("class", "update")
    .transition()
      .duration(750)
      .attr("x", function(d, i) { return i * 32; });

  // ENTER
  // Create new elements as needed.
  text.enter().append("text")
      .attr("class", "enter")
      .attr("dy", ".35em")
      .attr("y", -60)
      .attr("x", function(d, i) { return i * 32; })
      .style("fill-opacity", 1e-6)
      .text(function(d) { return d; })
    .transition()
      .duration(750)
      .attr("y", 0)
      .style("fill-opacity", 1);

  // EXIT
  // Remove old elements as needed.
  text.exit()
      .attr("class", "exit")
    .transition()
      .duration(750)
      .attr("y", 60)
      .style("fill-opacity", 1e-6)
      .remove();
}

// The initial display.
update(alphabet);

// Grab a random sample of letters from the alphabet, in alphabetical order.
setInterval(function() {
  update(d3.shuffle(alphabet)
      .slice(0, Math.floor(Math.random() * 26))
      .sort());
}, 1500);
})();
</script>

<script type="text/javascript">
(function () {
var c20 = d3.scale.category20();
var svg = d3.select("#color-scale")
     .append("svg")
     .attr("width", 400)
     .attr("height", 20);

svg.selectAll("circle")
    .data( d3.range(20) )
    .enter()
    .append("circle")
    .attr("r", 9 )
    .attr("cx", d3.scale.linear().domain([-1, 20]).range([0, 400]) )
    .attr("cy", 10)
    .attr("fill", c20 );
})();
</script>

<script id="migration-script">
(function () {
var width = 720,
    height = 720,
    outerRadius = Math.min(width, height) / 2 - 10,
    innerRadius = outerRadius - 24;

var formatPercent = d3.format(".1%");

var arc = d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(outerRadius);

var layout = d3.layout.chord()
    .padding(.04)
    .sortSubgroups(d3.descending)
    .sortChords(d3.ascending);

var path = d3.svg.chord()
    .radius(innerRadius);

var svg = d3.select("#migration").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("id", "circle")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

svg.append("circle")
    .attr("r", outerRadius);

queue()
    .defer(d3.csv, "data/regions.csv")
    .defer(d3.json, "data/migration.json")
    .await(ready);

function ready(error, cities, matrix) {
  if (error) throw error;

  // Compute the chord layout.
  layout.matrix(matrix);

  // Add a group per neighborhood.
  var group = svg.selectAll(".group")
      .data(layout.groups)
    .enter().append("g")
      .attr("class", "group")
      .on("mouseover", mouseover);

  // Add a mouseover title.
  group.append("title").text(function(d, i) {
    return cities[i].name + ": " + formatPercent(d.value) + " of origins";
  });

  // Add the group arc.
  var groupPath = group.append("path")
      .attr("id", function(d, i) { return "group" + i; })
      .attr("d", arc)
      .style("fill", function(d, i) { return cities[i].color; });

  // Add a text label.
  var groupText = group.append("text")
      .attr("x", 6)
      .attr("dy", 15);

  groupText.append("textPath")
      .attr("xlink:href", function(d, i) { return "#group" + i; })
      .text(function(d, i) { return cities[i].name; });

  // Remove the labels that don't fit. :(
  groupText.filter(function(d, i) { return groupPath[0][i].getTotalLength() / 2 - 16 < this.getComputedTextLength(); })
      .remove();

  // Add the chords.
  var chord = svg.selectAll(".chord")
      .data(layout.chords)
    .enter().append("path")
      .attr("class", "chord")
      .style("fill", function(d) { return cities[d.source.index].color; })
      .attr("d", path);

  // Add an elaborate mouseover title for each chord.
  chord.append("title").text(function(d) {
    return cities[d.source.index].name
        + " → " + cities[d.target.index].name
        + ": " + formatPercent(d.source.value)
        + "\n" + cities[d.target.index].name
        + " → " + cities[d.source.index].name
        + ": " + formatPercent(d.target.value);
  });

  function mouseover(d, i) {
    chord.classed("fade", function(p) {
      return p.source.index != i
          && p.target.index != i;
    });
  }
}
})();
</script>

        <script type="text/javascript">
            showCode('motivation')
            showCode('map')
            showCode('sunburst')
            showCode('transitions')
            showCode('migration')
        </script>

    </body>
</html>
